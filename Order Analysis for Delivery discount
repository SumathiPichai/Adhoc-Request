
--------------New shoppers in 2016 and their order history ------------------------


select  A.shopperid, 
 min(orderdate) ,
 max(case when b2b.ShopperID is not null then 'Y' else 'N' end)  as B2B_customer
 ,SUM(case when rownumber = 1 then  order_amt  else null end ) as order_1
,SUM(case when rownumber = 2 then  order_amt  else null end ) as order_2
,SUM(case when rownumber = 3 then  order_amt  else null end ) as order_3
,SUM(case when rownumber = 4 then  order_amt  else null end ) as order_4
,SUM(case when rownumber = 5 then  order_amt  else null end ) as order_5
,SUM(case when rownumber = 6 then  order_amt  else null end ) as order_6
,SUM(case when rownumber = 7 then  order_amt  else null end ) as order_7
,SUM(case when rownumber = 8 then  order_amt  else null end ) as order_8
,SUM(case when rownumber = 9 then  order_amt  else null end ) as order_9
,SUM(case when rownumber = 10 then  order_amt  else null end ) as order_10
,SUM(case when rownumber = 11  then  order_amt  else null end ) as order_11
,SUM(case when rownumber = 12 then  order_amt  else null end ) as order_12
,SUM(case when rownumber = 13 then  order_amt  else null end ) as order_13
,SUM(case when rownumber = 14 then  order_amt  else null end ) as order_14
,SUM(case when rownumber = 15 then  order_amt  else null end ) as order_15
,SUM(case when rownumber = 16 then  order_amt  else null end ) as order_16
,SUM(case when rownumber = 17 then  order_amt  else null end ) as order_17
,SUM(case when rownumber = 18 then  order_amt  else null end ) as order_18
,SUM(case when rownumber = 19 then  order_amt  else null end ) as order_19
,SUM(case when rownumber = 20 then  order_amt  else null end ) as order_20
,SUM(case when rownumber = 21 then  order_amt  else null end ) as order_21
,SUM(case when rownumber = 22 then  order_amt  else null end ) as order_22
,SUM(case when rownumber = 23 then  order_amt  else null end ) as order_23
,SUM(case when rownumber = 24 then  order_amt  else null end ) as order_24
,SUM(case when rownumber = 25 then  order_amt  else null end ) as order_25
,SUM(case when rownumber = 26 then  order_amt  else null end ) as order_26
,SUM(case when rownumber = 27 then  order_amt  else null end ) as order_27
,SUM(case when rownumber = 28 then  order_amt  else null end ) as order_28
,SUM(case when rownumber = 29 then  order_amt  else null end ) as order_29
,SUM(case when rownumber = 30 then  order_amt  else null end ) as order_30
,SUM(case when rownumber = 31 then  order_amt  else null end ) as order_31
,SUM(case when rownumber = 32 then  order_amt  else null end ) as order_32
,SUM(case when rownumber = 33 then  order_amt  else null end ) as order_33
,SUM(case when rownumber = 34 then  order_amt  else null end ) as order_34
,SUM(case when rownumber = 35 then  order_amt  else null end ) as order_35
,SUM(case when rownumber = 36 then  order_amt  else null end ) as order_36
,SUM(case when rownumber = 37 then  order_amt  else null end ) as order_37
,SUM(case when rownumber = 38 then  order_amt  else null end ) as order_38
,SUM(case when rownumber = 39 then  order_amt  else null end ) as order_39
,SUM(case when rownumber = 40 then  order_amt  else null end ) as order_40
,SUM(case when rownumber = 41 then  order_amt  else null end ) as order_41
,SUM(case when rownumber = 42 then  order_amt  else null end ) as order_42
,SUM(case when rownumber = 43 then  order_amt  else null end ) as order_43
,SUM(case when rownumber = 44 then  order_amt  else null end ) as order_44
,SUM(case when rownumber = 45 then  order_amt  else null end ) as order_45
,SUM(case when rownumber = 46 then  order_amt  else null end ) as order_46
,SUM(case when rownumber = 47 then  order_amt  else null end ) as order_47
,SUM(case when rownumber = 48 then  order_amt  else null end ) as order_48
,SUM(case when rownumber = 49 then  order_amt  else null end ) as order_49
,SUM(case when rownumber = 50 then  order_amt  else null end ) as order_50
,SUM(case when rownumber = 51 then  order_amt  else null end ) as order_51
,SUM(case when rownumber = 52 then  order_amt  else null end ) as order_52
,SUM(case when rownumber > 52 then  order_amt  else null end ) as order_53
 from 
 
 
 ( 
 
 select shopperid ,    (total - deliveryfee ) as order_amt , orderdate , total , ROW_NUMBER() OVER (PARTITION BY shopperid order by orderdate asc) rownumber
 
   from PROD_EDW_SIF.MOR_SMKT_ORD_ORDER  ordr
   
   where 
   shopperid in (   
select shopper_id  
 from PROD_EDW_SIF.MOR_SMKT_STR_SHOPPER where end_date = date'2099-12-31' and record_deleted_flag = 0 
and cast( date_created  as date) >= date'2016-01-01' and cast( date_created  as date) <date'2017-01-01' 
)
and  Status not in ('C a n c e l l e d','Cancelled')
and   (total - deliveryfee ) <> 0.0000
and cast(ss_exp_tmstmp as date) =date'2099-12-31'

) A 
left join 
    PROD_EDW_SIF.MOR_SMKT_STR_SHOPPERB2B b2b
    on 
                b2b.end_date = date'2099-12-31' 
    and   b2b. shopperid  = A.shopperid 
    and  b2b.Record_Deleted_Flag   = 0 
 
 group by 1 
 order by 
 order_53  	desc 
 ,order_52  	desc 
 ,order_51	desc 
 ,order_50	desc 
 ,order_49	desc 
 ,order_48	desc 
 ,order_47	desc 
 ,order_46	desc 
 ,order_45	desc 
 ,order_44	desc 
 ,order_43	desc 
 ,order_42	desc 
 ,order_41	desc 
 ,order_40	desc 
 ,order_39	desc 
 ,order_38	desc 
 ,order_37	desc 
 ,order_36	desc 
 ,order_35	desc 
 ,order_34	desc 
 ,order_33	desc 
 ,order_32	desc 
 ,order_31	desc 
 ,order_30	desc 
 ,order_29	desc 
 ,order_28	desc 
 ,order_27	desc 
 ,order_26	desc 
 ,order_25	desc 
 ,order_24	desc 
 ,order_23	desc 
 ,order_22	desc 
 ,order_21	desc 
 ,order_20	desc 
 ,order_19	desc 
 ,order_18	desc 
 ,order_17	desc 
 ,order_16	desc 
 ,order_15	desc 
 ,order_14	desc 
 ,order_13	desc 
 ,order_12	desc 
 ,order_11	desc 
 ,order_10	desc 
 ,order_9	desc 
 ,order_8	desc 
 ,order_7	desc 
 ,order_6	desc 
 ,order_5	desc 
 ,order_4	desc 
 ,order_3	desc 
 ,order_2	desc 
 ,order_1	desc 


------------------Shopper with alteast 1 order less than $60  and their shopping history between 01-Jan-2016 to 31-Dec-2016 ------

select  A.shopperid, 
 min(orderdate) ,
 max(case when b2b.ShopperID is not null then 'Y' else 'N' end)  as B2B_customer
,SUM(case when rownumber = 1 then  order_amt  else null end ) as order_1
,SUM(case when rownumber = 1 then  deliveryfee  else null end ) as del_fee_1
,SUM(case when rownumber = 2 then  order_amt  else null end ) as order_2
,SUM(case when rownumber = 2 then  deliveryfee  else null end ) as del_fee_2
,SUM(case when rownumber = 3 then  order_amt  else null end ) as order_3
,SUM(case when rownumber = 3 then  deliveryfee else null end ) as del_fee_3
,SUM(case when rownumber = 4 then  order_amt  else null end ) as order_4
,SUM(case when rownumber = 4 then  deliveryfee else null end ) as del_fee_4
,SUM(case when rownumber = 5 then  order_amt  else null end ) as order_5
,SUM(case when rownumber = 5 then  deliveryfee  else null end ) as del_fee_5
,SUM(case when rownumber = 6 then  order_amt  else null end ) as order_6
,SUM(case when rownumber = 6 then  deliveryfee  else null end ) as del_fee_6
,SUM(case when rownumber = 7 then  order_amt  else null end ) as order_7
,SUM(case when rownumber = 7 then  deliveryfee else null end ) as del_fee_7
,SUM(case when rownumber = 8 then  order_amt  else null end ) as order_8
,SUM(case when rownumber = 8 then  deliveryfee else null end ) as del_fee_8
,SUM(case when rownumber = 9 then  order_amt  else null end ) as order_9
,SUM(case when rownumber = 9 then  deliveryfee  else null end ) as del_fee_9
,SUM(case when rownumber = 10 then  order_amt  else null end ) as order_10
,SUM(case when rownumber = 10 then  deliveryfee else null end ) as del_fee_10
,SUM(case when rownumber = 11  then  order_amt  else null end ) as order_11
,SUM(case when rownumber = 11 then  deliveryfee else null end ) as del_fee_11
,SUM(case when rownumber = 12 then  order_amt  else null end ) as order_12
,SUM(case when rownumber = 12 then deliveryfee  else null end ) as del_fee_12
,SUM(case when rownumber = 13 then  order_amt  else null end ) as order_13
,SUM(case when rownumber = 13 then  deliveryfee  else null end ) as del_fee_13
,SUM(case when rownumber = 14 then  order_amt  else null end ) as order_14
,SUM(case when rownumber = 14 then  deliveryfee  else null end ) as del_fee_14
,SUM(case when rownumber = 15 then  order_amt  else null end ) as order_15
,SUM(case when rownumber = 15 then  deliveryfee  else null end ) as del_fee_15
,SUM(case when rownumber = 16 then  order_amt  else null end ) as order_16
,SUM(case when rownumber = 16 then  deliveryfee  else null end ) as del_fee_16
,SUM(case when rownumber = 17 then  order_amt  else null end ) as order_17
,SUM(case when rownumber = 17 then  deliveryfee  else null end ) as del_fee_17
,SUM(case when rownumber = 18 then  order_amt  else null end ) as order_18
,SUM(case when rownumber = 18 then  deliveryfee  else null end ) as del_fee_18
,SUM(case when rownumber = 19 then  order_amt  else null end ) as order_19
,SUM(case when rownumber = 19 then deliveryfee  else null end ) as del_fee_19
,SUM(case when rownumber = 20 then  order_amt  else null end ) as order_20
,SUM(case when rownumber = 20 then deliveryfee else null end ) as del_fee_20
,SUM(case when rownumber = 21 then  order_amt  else null end ) as order_21
,SUM(case when rownumber = 21 then  deliveryfee  else null end ) as del_fee_21
,SUM(case when rownumber = 22 then  order_amt  else null end ) as order_22
,SUM(case when rownumber = 22 then  deliveryfee else null end ) as del_fee_22
,SUM(case when rownumber = 23 then  order_amt  else null end ) as order_23
,SUM(case when rownumber = 23 then  deliveryfee  else null end ) as del_fee_23
,SUM(case when rownumber = 24 then  order_amt  else null end ) as order_24
,SUM(case when rownumber = 24 then  deliveryfee  else null end ) as del_fee_24
,SUM(case when rownumber = 25 then  order_amt  else null end ) as order_25
,SUM(case when rownumber = 25 then  deliveryfee  else null end ) as del_fee_25
,SUM(case when rownumber = 26 then  order_amt  else null end ) as order_26
,SUM(case when rownumber = 26 then  deliveryfee  else null end ) as del_fee_26
,SUM(case when rownumber = 27 then  order_amt  else null end ) as order_27
,SUM(case when rownumber = 27 then  deliveryfee  else null end ) as del_fee_27
,SUM(case when rownumber = 28 then  order_amt  else null end ) as order_28
,SUM(case when rownumber = 28 then  deliveryfee  else null end ) as del_fee_28
,SUM(case when rownumber = 29 then  order_amt  else null end ) as order_29
,SUM(case when rownumber = 29 then  deliveryfee  else null end ) as del_fee_29
,SUM(case when rownumber = 30 then  order_amt  else null end ) as order_30
,SUM(case when rownumber = 30 then  deliveryfee  else null end ) as del_fee_30
,SUM(case when rownumber = 31 then  order_amt  else null end ) as order_31
,SUM(case when rownumber = 31 then  deliveryfee  else null end ) as del_fee_31
,SUM(case when rownumber = 32 then  order_amt  else null end ) as order_32
,SUM(case when rownumber = 32 then  deliveryfee else null end ) as del_fee_32
,SUM(case when rownumber = 33 then  order_amt  else null end ) as order_33
,SUM(case when rownumber = 33 then  deliveryfee  else null end ) as del_fee_33
,SUM(case when rownumber = 34 then  order_amt  else null end ) as order_34
,SUM(case when rownumber = 34 then deliveryfee else null end ) as del_fee_34
,SUM(case when rownumber = 35 then  order_amt  else null end ) as order_35
,SUM(case when rownumber = 35 then deliveryfee  else null end ) as del_fee_35
,SUM(case when rownumber = 36 then  order_amt  else null end ) as order_36
,SUM(case when rownumber = 36 then  deliveryfee else null end ) as del_fee_36
,SUM(case when rownumber = 37 then  order_amt  else null end ) as order_37
,SUM(case when rownumber = 37 then  deliveryfee else null end ) as del_fee_37
,SUM(case when rownumber = 38 then  order_amt  else null end ) as order_38
,SUM(case when rownumber = 38 then  deliveryfee  else null end ) as del_fee_38
,SUM(case when rownumber = 39 then  order_amt  else null end ) as order_39
,SUM(case when rownumber = 39 then  deliveryfee  else null end ) as del_fee_39
,SUM(case when rownumber = 40 then  order_amt  else null end ) as order_40
,SUM(case when rownumber = 40 then deliveryfee  else null end ) as del_fee_40
,SUM(case when rownumber = 41 then  order_amt  else null end ) as order_41
,SUM(case when rownumber = 41 then  deliveryfee  else null end ) as del_fee_41
,SUM(case when rownumber = 42 then  order_amt  else null end ) as order_42
,SUM(case when rownumber = 42 then  deliveryfee else null end ) as del_fee_42
,SUM(case when rownumber = 43 then  order_amt  else null end ) as order_43
,SUM(case when rownumber = 43 then  deliveryfee  else null end ) as del_fee_43
,SUM(case when rownumber = 44 then  order_amt  else null end ) as order_44
,SUM(case when rownumber = 44 then  deliveryfee  else null end ) as del_fee_44
,SUM(case when rownumber = 45 then  order_amt  else null end ) as order_45
,SUM(case when rownumber = 45 then  deliveryfee  else null end ) as del_fee_45
,SUM(case when rownumber = 46 then  order_amt  else null end ) as order_46
,SUM(case when rownumber = 46 then  deliveryfee  else null end ) as del_fee_46
,SUM(case when rownumber = 47 then  order_amt  else null end ) as order_47
,SUM(case when rownumber = 47 then  deliveryfee  else null end ) as del_fee_47
,SUM(case when rownumber = 48 then  order_amt  else null end ) as order_48
,SUM(case when rownumber = 48 then  deliveryfee else null end ) as del_fee_48
,SUM(case when rownumber = 49 then  order_amt  else null end ) as order_49
,SUM(case when rownumber = 49 then  deliveryfee else null end ) as del_fee_49
,SUM(case when rownumber = 50 then  order_amt  else null end ) as order_50
,SUM(case when rownumber = 50 then  deliveryfee  else null end ) as del_fee_50
,SUM(case when rownumber = 51 then  order_amt  else null end ) as order_51
,SUM(case when rownumber = 51 then  deliveryfee  else null end ) as del_fee_51
,SUM(case when rownumber = 52 then  order_amt  else null end ) as order_52
,SUM(case when rownumber = 52 then  deliveryfee else null end ) as del_fee_52
,SUM(case when rownumber > 52 then  order_amt  else null end ) as order_53
,SUM(case when rownumber > 52 then deliveryfee  else null end ) as del_fee_53
 from 
 
 
 ( 
 
 select shopperid ,    (total - deliveryfee ) as order_amt , orderdate , deliveryfee , ROW_NUMBER() OVER (PARTITION BY shopperid order by orderdate asc) rownumber
 
   from PROD_EDW_SIF.MOR_SMKT_ORD_ORDER  ordr
   
   where 
   shopperid in (   
select distinct shopperid 
 
   from PROD_EDW_SIF.MOR_SMKT_ORD_ORDER  ordr
 where 
            cast(ss_exp_tmstmp as date) =date'2099-12-31'
 and  (total - deliveryfee ) <= 60 
  and orderdate >= date'2016-01-01' and orderdate < date'2017-01-01' 
)
and  Status not in ('C a n c e l l e d','Cancelled')
and   (total - deliveryfee ) <> 0.0000
and cast(ss_exp_tmstmp as date) =date'2099-12-31'
and   orderdate >= date'2016-01-01' and orderdate < date'2017-01-01' 
) A 
left join 
    PROD_EDW_SIF.MOR_SMKT_STR_SHOPPERB2B b2b
    on 
                b2b.end_date = date'2099-12-31' 
    and   b2b. shopperid  = A.shopperid 
    and  b2b.Record_Deleted_Flag   = 0 
 
 group by 1 
  order by 
   order_53  	desc 
  ,order_52  	desc 
  ,order_51	desc 
  ,order_50	desc 
  ,order_49	desc 
  ,order_48	desc 
  ,order_47	desc 
  ,order_46	desc 
  ,order_45	desc 
  ,order_44	desc 
  ,order_43	desc 
  ,order_42	desc 
  ,order_41	desc 
  ,order_40	desc 
  ,order_39	desc 
  ,order_38	desc 
  ,order_37	desc 
  ,order_36	desc 
  ,order_35	desc 
  ,order_34	desc 
  ,order_33	desc 
  ,order_32	desc 
  ,order_31	desc 
  ,order_30	desc 
  ,order_29	desc 
  ,order_28	desc 
  ,order_27	desc 
  ,order_26	desc 
  ,order_25	desc 
  ,order_24	desc 
  ,order_23	desc 
  ,order_22	desc 
  ,order_21	desc 
  ,order_20	desc 
  ,order_19	desc 
  ,order_18	desc 
  ,order_17	desc 
  ,order_16	desc 
  ,order_15	desc 
  ,order_14	desc 
  ,order_13	desc 
  ,order_12	desc 
  ,order_11	desc 
  ,order_10	desc 
  ,order_9	desc 
  ,order_8	desc 
  ,order_7	desc 
  ,order_6	desc 
  ,order_5	desc 
  ,order_4	desc 
  ,order_3	desc 
  ,order_2	desc 
  ,order_1	desc 
  
 
 
 ---Shopper Order History for 2015 and 2016 ---------------
 
 select 
  ordr.shopperid 
 ,min(orderdate)  
 ,max(case when b2b.ShopperID is not null then 'Y' else 'N' end)  as B2B_customer 
 , max(count_of_orders) 
 ,max(CNT_MNDY_ORDRS) 
 , max(CNT_TUES_ORDRS)        
, max(CNT_WED_ORDRS )         
, max(CNT_THU_ORDRS)           
 ,max(CNT_FRI_ORDRS )             
,max(CNT_SAT_ORDRS )            
, max(CNT_SUN_ORDRS  )   
,SUM(case when rownumber = 1 then  order_amt  else null end ) as order_1
,SUM(case when rownumber = 1 then  deliveryfee  else null end ) as del_fee_1
,MAX(case when rownumber = 1  then  date1.DOW  else null end ) as DOW_1
,MAX(case when rownumber = 1  then   branch.store_nbr    else null end ) as store_1
,Max(case when rownumber = 1 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_1
,SUM(case when rownumber = 2 then  order_amt  else null end ) as order_2
,SUM(case when rownumber = 2 then  deliveryfee  else null end ) as del_fee_2
,MAX(case when rownumber = 2  then  date1.DOW  else null end ) as DOW_2
,MAX(case when rownumber = 2  then   branch.store_nbr    else null end ) as store_2
,Max(case when rownumber =2 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_2
,SUM(case when rownumber = 3 then  order_amt  else null end ) as order_3
,SUM(case when rownumber = 3 then  deliveryfee else null end ) as del_fee_3
,MAX(case when rownumber = 3  then  date1.DOW  else null end ) as DOW_3
,MAX(case when rownumber = 3  then   branch.store_nbr    else null end ) as store_3
,Max(case when rownumber = 3 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_3
,SUM(case when rownumber = 4 then  order_amt  else null end ) as order_4
,SUM(case when rownumber = 4 then  deliveryfee else null end ) as del_fee_4
,MAX(case when rownumber = 4  then  date1.DOW  else null end ) as DOW_4
,MAX(case when rownumber = 4  then   branch.store_nbr    else null end ) as store_4
,Max(case when rownumber = 4  and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_4
,SUM(case when rownumber = 5 then  order_amt  else null end ) as order_5
,SUM(case when rownumber = 5 then  deliveryfee  else null end ) as del_fee_5
,MAX(case when rownumber = 5  then  date1.DOW  else null end ) as DOW_5
,MAX(case when rownumber = 5  then   branch.store_nbr    else null end ) as store_5
,Max(case when rownumber = 5 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_5
,SUM(case when rownumber = 6 then  order_amt  else null end ) as order_6
,SUM(case when rownumber = 6 then  deliveryfee  else null end ) as del_fee_6
,MAX(case when rownumber = 6  then  date1.DOW  else null end ) as DOW_6
,MAX(case when rownumber = 6  then   branch.store_nbr    else null end ) as store_6
,Max(case when rownumber = 6 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_6
,SUM(case when rownumber = 7 then  order_amt  else null end ) as order_7
,SUM(case when rownumber = 7 then  deliveryfee else null end ) as del_fee_7
,MAX(case when rownumber = 7  then  date1.DOW  else null end ) as DOW_7
,MAX(case when rownumber = 7  then   branch.store_nbr    else null end ) as store_7
,Max(case when rownumber = 7 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_7
,SUM(case when rownumber = 8 then  order_amt  else null end ) as order_8
,SUM(case when rownumber = 8 then  deliveryfee else null end ) as del_fee_8
,MAX(case when rownumber = 8  then  date1.DOW  else null end ) as DOW_8
,MAX(case when rownumber = 8  then   branch.store_nbr    else null end ) as store_8
,Max(case when rownumber = 8 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_8
,SUM(case when rownumber = 9 then  order_amt  else null end ) as order_9
,SUM(case when rownumber = 9 then  deliveryfee  else null end ) as del_fee_9
,MAX(case when rownumber = 9  then  date1.DOW  else null end ) as DOW_9
,MAX(case when rownumber = 9  then   branch.store_nbr    else null end ) as store_9
,Max(case when rownumber = 9 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_9
,SUM(case when rownumber = 10 then  order_amt  else null end ) as order_10
,SUM(case when rownumber = 10 then  deliveryfee else null end ) as del_fee_10
,MAX(case when rownumber = 10 then  date1.DOW  else null end ) as DOW_10
,MAX(case when rownumber = 10  then   branch.store_nbr    else null end ) as store_10
,Max(case when rownumber = 10 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_10
,SUM(case when rownumber = 11  then  order_amt  else null end ) as order_11
,SUM(case when rownumber = 11 then  deliveryfee else null end ) as del_fee_11
,MAX(case when rownumber = 11  then  date1.DOW  else null end ) as DOW_11
,MAX(case when rownumber = 11  then   branch.store_nbr    else null end ) as store_11
,Max(case when rownumber = 11 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_11
,SUM(case when rownumber = 12 then  order_amt  else null end ) as order_12
,SUM(case when rownumber = 12 then deliveryfee  else null end ) as del_fee_12
,MAX(case when rownumber = 12  then  date1.DOW  else null end ) as DOW_12
,MAX(case when rownumber = 12  then   branch.store_nbr    else null end ) as store_12
,Max(case when rownumber = 12 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_12
,SUM(case when rownumber = 13 then  order_amt  else null end ) as order_13
,SUM(case when rownumber = 13 then  deliveryfee  else null end ) as del_fee_13
,MAX(case when rownumber = 13  then  date1.DOW  else null end ) as DOW_13
,MAX(case when rownumber = 13  then   branch.store_nbr    else null end ) as store_13
,Max(case when rownumber = 13 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_13
,SUM(case when rownumber = 14 then  order_amt  else null end ) as order_14
,SUM(case when rownumber = 14 then  deliveryfee  else null end ) as del_fee_14
,MAX(case when rownumber = 14  then  date1.DOW  else null end ) as DOW_14
,MAX(case when rownumber = 14  then   branch.store_nbr    else null end ) as store_14
,Max(case when rownumber = 14 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_14
,SUM(case when rownumber = 15 then  order_amt  else null end ) as order_15
,SUM(case when rownumber = 15 then  deliveryfee  else null end ) as del_fee_15
,MAX(case when rownumber = 15  then  date1.DOW  else null end ) as DOW_15
,MAX(case when rownumber = 15  then   branch.store_nbr    else null end ) as store_15
,Max(case when rownumber = 15 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_15
,SUM(case when rownumber = 16 then  order_amt  else null end ) as order_16
,SUM(case when rownumber = 16 then  deliveryfee  else null end ) as del_fee_16
,MAX(case when rownumber = 16  then  date1.DOW  else null end ) as DOW_16
,MAX(case when rownumber = 16  then   branch.store_nbr    else null end ) as store_16
,Max(case when rownumber = 16 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_16
,SUM(case when rownumber = 17 then  order_amt  else null end ) as order_17
,SUM(case when rownumber = 17 then  deliveryfee  else null end ) as del_fee_17
,MAX(case when rownumber = 17  then  date1.DOW  else null end ) as DOW_17
,MAX(case when rownumber = 17  then   branch.store_nbr    else null end ) as store_17
,Max(case when rownumber = 17 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_17
,SUM(case when rownumber = 18 then  order_amt  else null end ) as order_18
,SUM(case when rownumber = 18 then  deliveryfee  else null end ) as del_fee_18
,MAX(case when rownumber = 18  then  date1.DOW  else null end ) as DOW_18
,MAX(case when rownumber = 18  then   branch.store_nbr    else null end ) as store_18
,Max(case when rownumber = 18 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_18
,SUM(case when rownumber = 19 then  order_amt  else null end ) as order_19
,SUM(case when rownumber = 19 then deliveryfee  else null end ) as del_fee_19
,MAX(case when rownumber = 19  then  date1.DOW  else null end ) as DOW_19
,MAX(case when rownumber = 19  then   branch.store_nbr    else null end ) as store_19
,Max(case when rownumber = 19 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_19
,SUM(case when rownumber = 20 then  order_amt  else null end ) as order_20
,SUM(case when rownumber = 20 then deliveryfee else null end ) as del_fee_20
,MAX(case when rownumber = 20  then  date1.DOW  else null end ) as DOW_20
,MAX(case when rownumber = 20  then   branch.store_nbr    else null end ) as store_20
,Max(case when rownumber = 20 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_20
,SUM(case when rownumber = 21 then  order_amt  else null end ) as order_21
,SUM(case when rownumber = 21 then  deliveryfee  else null end ) as del_fee_21
,MAX(case when rownumber = 21  then  date1.DOW  else null end ) as DOW_21
,MAX(case when rownumber = 21  then   branch.store_nbr    else null end ) as store_21
,Max(case when rownumber = 21 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_21
,SUM(case when rownumber = 22 then  order_amt  else null end ) as order_22
,SUM(case when rownumber = 22 then  deliveryfee else null end ) as del_fee_22
,MAX(case when rownumber = 22  then  date1.DOW  else null end ) as DOW_22
,MAX(case when rownumber = 22  then   branch.store_nbr    else null end ) as store_22
,Max(case when rownumber = 22 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_22
,SUM(case when rownumber = 23 then  order_amt  else null end ) as order_23
,SUM(case when rownumber = 23 then  deliveryfee  else null end ) as del_fee_23
,MAX(case when rownumber = 23  then  date1.DOW  else null end ) as DOW_23
,MAX(case when rownumber = 23  then   branch.store_nbr    else null end ) as store_23
,Max(case when rownumber = 23 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_23
,SUM(case when rownumber = 24 then  order_amt  else null end ) as order_24
,SUM(case when rownumber = 24 then  deliveryfee  else null end ) as del_fee_24
,MAX(case when rownumber = 24  then  date1.DOW  else null end ) as DOW_24
,MAX(case when rownumber = 24  then   branch.store_nbr    else null end ) as store_24
,Max(case when rownumber = 24 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_24
,SUM(case when rownumber = 25 then  order_amt  else null end ) as order_25
,SUM(case when rownumber = 25 then  deliveryfee  else null end ) as del_fee_25
,MAX(case when rownumber = 25  then  date1.DOW  else null end ) as DOW_25
,MAX(case when rownumber = 25  then   branch.store_nbr    else null end ) as store_25
,Max(case when rownumber = 25 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_25
,SUM(case when rownumber = 26 then  order_amt  else null end ) as order_26
,SUM(case when rownumber = 26 then  deliveryfee  else null end ) as del_fee_26
,MAX(case when rownumber = 26  then  date1.DOW  else null end ) as DOW_26
,MAX(case when rownumber = 26  then   branch.store_nbr    else null end ) as store_26
,Max(case when rownumber = 26 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_26
,SUM(case when rownumber = 27 then  order_amt  else null end ) as order_27
,SUM(case when rownumber = 27 then  deliveryfee  else null end ) as del_fee_27
,MAX(case when rownumber = 27  then  date1.DOW  else null end ) as DOW_27
,MAX(case when rownumber = 27  then   branch.store_nbr    else null end ) as store_27
,Max(case when rownumber = 27 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_27
,SUM(case when rownumber = 28 then  order_amt  else null end ) as order_28
,SUM(case when rownumber = 28 then  deliveryfee  else null end ) as del_fee_28
,MAX(case when rownumber = 28  then  date1.DOW  else null end ) as DOW_28
,MAX(case when rownumber = 28  then   branch.store_nbr    else null end ) as store_28
,Max(case when rownumber = 28 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_28
,SUM(case when rownumber = 29 then  order_amt  else null end ) as order_29
,SUM(case when rownumber = 29 then  deliveryfee  else null end ) as del_fee_29
,MAX(case when rownumber = 29  then  date1.DOW  else null end ) as DOW_29
,MAX(case when rownumber = 29  then   branch.store_nbr    else null end ) as store_29
,Max(case when rownumber = 29 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_29
,SUM(case when rownumber = 30 then  order_amt  else null end ) as order_30
,SUM(case when rownumber = 30 then  deliveryfee  else null end ) as del_fee_30
,MAX(case when rownumber = 30  then  date1.DOW  else null end ) as DOW_30
,MAX(case when rownumber = 30  then   branch.store_nbr    else null end ) as store_30
,Max(case when rownumber = 30 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_30
,SUM(case when rownumber = 31 then  order_amt  else null end ) as order_31
,SUM(case when rownumber = 31 then  deliveryfee  else null end ) as del_fee_31
,MAX(case when rownumber = 31  then  date1.DOW  else null end ) as DOW_31
,MAX(case when rownumber = 31  then   branch.store_nbr    else null end ) as store_31
,Max(case when rownumber = 31 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_31
,SUM(case when rownumber = 32 then  order_amt  else null end ) as order_32
,SUM(case when rownumber = 32 then  deliveryfee else null end ) as del_fee_32
,MAX(case when rownumber = 32  then  date1.DOW  else null end ) as DOW_32
,MAX(case when rownumber = 32  then   branch.store_nbr    else null end ) as store_32
,Max(case when rownumber = 32 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_32
,SUM(case when rownumber = 33 then  order_amt  else null end ) as order_33
,SUM(case when rownumber = 33 then  deliveryfee  else null end ) as del_fee_33
,MAX(case when rownumber = 33  then  date1.DOW  else null end ) as DOW_33
,MAX(case when rownumber = 33  then   branch.store_nbr    else null end ) as store_33
,Max(case when rownumber = 33 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_33
,SUM(case when rownumber = 34 then  order_amt  else null end ) as order_34
,SUM(case when rownumber = 34 then deliveryfee else null end ) as del_fee_34
,MAX(case when rownumber = 34  then  date1.DOW  else null end ) as DOW_34
,MAX(case when rownumber = 34  then   branch.store_nbr    else null end ) as store_34
,Max(case when rownumber = 34 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_34
,SUM(case when rownumber = 35 then  order_amt  else null end ) as order_35
,SUM(case when rownumber = 35 then deliveryfee  else null end ) as del_fee_35
,MAX(case when rownumber = 35  then  date1.DOW  else null end ) as DOW_35
,MAX(case when rownumber = 35  then   branch.store_nbr    else null end ) as store_35
,Max(case when rownumber = 35 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_35
,SUM(case when rownumber = 36 then  order_amt  else null end ) as order_36
,SUM(case when rownumber = 36 then  deliveryfee else null end ) as del_fee_36
,MAX(case when rownumber = 36  then  date1.DOW  else null end ) as DOW_36
,MAX(case when rownumber = 36  then   branch.store_nbr    else null end ) as store_36
,Max(case when rownumber = 36 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_36
,SUM(case when rownumber = 37 then  order_amt  else null end ) as order_37
,SUM(case when rownumber = 37 then  deliveryfee else null end ) as del_fee_37
,MAX(case when rownumber = 37  then  date1.DOW  else null end ) as DOW_37
,MAX(case when rownumber = 37  then   branch.store_nbr    else null end ) as store_37
,Max(case when rownumber = 37 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_37
,SUM(case when rownumber = 38 then  order_amt  else null end ) as order_38
,SUM(case when rownumber = 38 then  deliveryfee  else null end ) as del_fee_38
,MAX(case when rownumber = 38  then  date1.DOW  else null end ) as DOW_38
,MAX(case when rownumber = 38  then   branch.store_nbr    else null end ) as store_38
,Max(case when rownumber = 38 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_38
,SUM(case when rownumber = 39 then  order_amt  else null end ) as order_39
,SUM(case when rownumber = 39 then  deliveryfee  else null end ) as del_fee_39
,MAX(case when rownumber = 39 then  date1.DOW  else null end ) as DOW_39
,MAX(case when rownumber = 39  then   branch.store_nbr    else null end ) as store_39
,Max(case when rownumber = 39 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_39
,SUM(case when rownumber = 40 then  order_amt  else null end ) as order_40
,SUM(case when rownumber = 40 then deliveryfee  else null end ) as del_fee_40
,MAX(case when rownumber = 40  then  date1.DOW  else null end ) as DOW_40
,MAX(case when rownumber = 40  then   branch.store_nbr    else null end ) as store_40
,Max(case when rownumber = 40 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_40
,SUM(case when rownumber = 41 then  order_amt  else null end ) as order_41
,SUM(case when rownumber = 41 then  deliveryfee  else null end ) as del_fee_41
,MAX(case when rownumber = 41  then  date1.DOW  else null end ) as DOW_41
,MAX(case when rownumber = 41  then   branch.store_nbr    else null end ) as store_41
,Max(case when rownumber = 41 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_41
,SUM(case when rownumber = 42 then  order_amt  else null end ) as order_42
,SUM(case when rownumber = 42 then  deliveryfee else null end ) as del_fee_42
,MAX(case when rownumber = 42  then  date1.DOW  else null end ) as DOW_42
,MAX(case when rownumber = 42  then   branch.store_nbr    else null end ) as store_42
,Max(case when rownumber = 42 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_42
,SUM(case when rownumber = 43 then  order_amt  else null end ) as order_43
,SUM(case when rownumber = 43 then  deliveryfee  else null end ) as del_fee_43
,MAX(case when rownumber = 43  then  date1.DOW  else null end ) as DOW_43
,MAX(case when rownumber = 43  then   branch.store_nbr    else null end ) as store_43
,Max(case when rownumber = 43 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_43
,SUM(case when rownumber = 44 then  order_amt  else null end ) as order_44
,SUM(case when rownumber = 44 then  deliveryfee  else null end ) as del_fee_44
,MAX(case when rownumber = 44  then  date1.DOW  else null end ) as DOW_44
,MAX(case when rownumber = 44  then   branch.store_nbr    else null end ) as store_44
,Max(case when rownumber = 44 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_44
,SUM(case when rownumber = 45 then  order_amt  else null end ) as order_45
,SUM(case when rownumber = 45 then  deliveryfee  else null end ) as del_fee_45
,MAX(case when rownumber = 45  then  date1.DOW  else null end ) as DOW_45
,MAX(case when rownumber = 45  then   branch.store_nbr    else null end ) as store_45
,Max(case when rownumber = 45 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_45
,SUM(case when rownumber = 46 then  order_amt  else null end ) as order_46
,SUM(case when rownumber = 46 then  deliveryfee  else null end ) as del_fee_46
,MAX(case when rownumber = 46  then  date1.DOW  else null end ) as DOW_46
,MAX(case when rownumber = 46 then   branch.store_nbr    else null end ) as store_46
,Max(case when rownumber = 46 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_46
,SUM(case when rownumber = 47 then  order_amt  else null end ) as order_47
,SUM(case when rownumber = 47 then  deliveryfee  else null end ) as del_fee_47
,MAX(case when rownumber = 47  then  date1.DOW  else null end ) as DOW_47
,MAX(case when rownumber = 47  then   branch.store_nbr    else null end ) as store_47
,Max(case when rownumber = 47 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_47
,SUM(case when rownumber = 48 then  order_amt  else null end ) as order_48
,SUM(case when rownumber = 48 then  deliveryfee else null end ) as del_fee_48
,MAX(case when rownumber = 48  then  date1.DOW  else null end ) as DOW_48
,MAX(case when rownumber = 48  then   branch.store_nbr    else null end ) as store_48
,Max(case when rownumber = 48 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_48
,SUM(case when rownumber = 49 then  order_amt  else null end ) as order_49
,SUM(case when rownumber = 49 then  deliveryfee else null end ) as del_fee_49
,MAX(case when rownumber = 49  then  date1.DOW  else null end ) as DOW_49
,MAX(case when rownumber = 49  then   branch.store_nbr    else null end ) as store_49
,Max(case when rownumber = 49 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_49
,SUM(case when rownumber = 50 then  order_amt  else null end ) as order_50
,SUM(case when rownumber = 50 then  deliveryfee  else null end ) as del_fee_50
,MAX(case when rownumber = 50  then  date1.DOW  else null end ) as DOW_50
,MAX(case when rownumber = 50  then   branch.store_nbr    else null end ) as store_50
,Max(case when rownumber = 50 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_50
,SUM(case when rownumber = 51 then  order_amt  else null end ) as order_51
,SUM(case when rownumber = 51 then  deliveryfee  else null end ) as del_fee_51
,MAX(case when rownumber = 51  then  date1.DOW  else null end ) as DOW_51
,MAX(case when rownumber = 51  then   branch.store_nbr    else null end ) as store_51
,Max(case when rownumber = 51 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_51
,SUM(case when rownumber = 52 then  order_amt  else null end ) as order_52
,SUM(case when rownumber = 52 then  deliveryfee else null end ) as del_fee_52
,MAX(case when rownumber =  52  then  date1.DOW  else null end ) as DOW_52
,MAX(case when rownumber = 52  then   branch.store_nbr    else null end ) as store_52
,Max(case when rownumber = 52 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_52
,SUM(case when rownumber > 52 then  order_amt  else null end ) as order_53
,SUM(case when rownumber > 52 then deliveryfee  else null end ) as del_fee_53
,MAX(case when rownumber > 52  then  date1.DOW  else null end ) as DOW_53
,MAX(case when rownumber > 52  then   branch.store_nbr    else null end ) as store_53
,Max(case when rownumber > 52 and dlvry.orderid is not null  then 'Y' else 'N' end) as dlvrpass_53
 from 
  
 ( 
 
 select ordr.shopperid, 
     ID 
  , count_of_orders 
 ,CNT_MNDY_ORDRS
 , CNT_TUES_ORDRS       
, CNT_WED_ORDRS         
, CNT_THU_ORDRS          
 ,CNT_FRI_ORDRS             
,CNT_SAT_ORDRS            
, CNT_SUN_ORDRS    
,  (total - deliveryfee ) as order_amt , orderdate , deliveryfee , ROW_NUMBER() OVER (PARTITION BY ordr.shopperid order by orderdate asc) rownumber
 
   from PROD_EDW_SIF.MOR_SMKT_ORD_ORDER  ordr
 
   inner join 
  (
  select 
    shopperid ,
    count(distinct ID) as  count_of_orders , 
    count(distinct  (case when dow  = 1 then ID else null end )) as CNT_MNDY_ORDRS, 
count(distinct  (case when dow  = 2 then  ID else null  end )) as CNT_TUES_ORDRS, 
     count(distinct  ( case when dow  =3  then  ID else null  end )) as CNT_WED_ORDRS, 
     count(distinct  ( case when dow  = 4 then  ID else null  end )) as CNT_THU_ORDRS, 
    count(distinct  (  case when dow  = 5 then  ID else null  end )) as CNT_FRI_ORDRS, 
    count(distinct  (  case when dow  = 6 then ID else null  end )) as CNT_SAT_ORDRS, 
     count(distinct  ( case when dow  = 7 then  ID else null  end  )) as CNT_SUN_ORDRS 
   
     from PROD_EDW_SIF.MOR_SMKT_ORD_ORDER  ordr
     left join 
      PROD_EDW_WIL.DIM_DATE_CURR_V    date1
     on date1.clndr_date =  cast(orderdate as date)
   where 
              cast(ss_exp_tmstmp as date) =date'2099-12-31'
    and orderdate >= date'2016-01-01' and orderdate < date'2017-01-01' 
    and Status not in ('C a n c e l l e d','Cancelled')
    
    group by 1 
   )  SHPR
   on shpr.shopperid = ordr.shopperid 
  where 
      cast(ordr.ss_exp_tmstmp as date) =date'2099-12-31'
    and ordr.orderdate >= date'2016-01-01' and ordr.orderdate < date'2017-01-01' 
    and ordr.Status not in ('C a n c e l l e d','Cancelled')
    ) as ORDR
   left join 
  ( select Shopper_id , max(lc.segment_desc) as Life_segment,  max(PC.segment_desc)  as Price_segment 
   from
  (select  distinct a.shopper_id as Shopper_id, one.onecardnumber
  from PROD_EDW_SIF.MOR_SMKT_STR_SHOPPER a 
  inner join (sel shopperid, onecardnumber from PROD_EDW_SIF.MOR_SMKT_STR_SHOPPERONECARD) one
  on a.shopper_id = one.shopperid
  where a.status_id in ('99','100')    ) optin
  left join 
   PROD_WA_TEAM_IDA.V_CUST_LIFESTAGE_SEGMENT_CURR   LC 
  on 
  optin.onecardnumber = lc.lylty_card_nbr
  
  left join 
    PROD_WA_TEAM_IDA.V_CUST_PRICE_SEGMENT_CURR  PC
   
  on optin.onecardnumber =pc.lylty_card_nbr
  group by 1 
  )sgmt 
  
  on sgmt.shopper_id = ordr. shopperid

left join 
    PROD_EDW_SIF.MOR_SMKT_STR_SHOPPERB2B b2b
    on 
                b2b.end_date = date'2099-12-31' 
    and   b2b. shopperid  = ordr.shopperid 
    and  b2b.Record_Deleted_Flag   = 0 
 left join 
      PROD_EDW_WIL.DIM_DATE_CURR_V    date1
     on date1.clndr_date =  cast(orderdate as date)
   
 left join 
       (select  order_no , cast(substr( min( case when order_status_ind = 'DIS' then '1-' else '2-' end ||branch_no),3)  as integer)  as store_nbr 
  from PROD_EDW_SIF.MOR_SMKT_ECF_Order_Header where 
    cast(ss_exp_tmstmp as date)  = date'2099-12-31' 
 group by 
 order_no ) branch 
 on branch.order_no = ordr.id 
 
 left join 
 PROD_EDW_SIF.MOR_SMKT_ORD_ORDERDISCOUNT dlvry 
 on 
         dlvry.orderid = ordr.id 
and  dlvry.source ='DeliveryPass'
and dlvry.end_date = date'2099-12-31' 
and dlvry.record_deleted_flag = 0 
 
 group by 1 
 
 order by 
   order_53  	desc 
  ,order_52  	desc 
  ,order_51	desc 
  ,order_50	desc 
  ,order_49	desc 
  ,order_48	desc 
  ,order_47	desc 
  ,order_46	desc 
  ,order_45	desc 
  ,order_44	desc 
  ,order_43	desc 
  ,order_42	desc 
  ,order_41	desc 
  ,order_40	desc 
  ,order_39	desc 
  ,order_38	desc 
  ,order_37	desc 
  ,order_36	desc 
  ,order_35	desc 
  ,order_34	desc 
  ,order_33	desc 
  ,order_32	desc 
  ,order_31	desc 
  ,order_30	desc 
  ,order_29	desc 
  ,order_28	desc 
  ,order_27	desc 
  ,order_26	desc 
  ,order_25	desc 
  ,order_24	desc 
  ,order_23	desc 
  ,order_22	desc 
  ,order_21	desc 
  ,order_20	desc 
  ,order_19	desc 
  ,order_18	desc 
  ,order_17	desc 
  ,order_16	desc 
  ,order_15	desc 
  ,order_14	desc 
  ,order_13	desc 
  ,order_12	desc 
  ,order_11	desc 
  ,order_10	desc 
  ,order_9	desc 
  ,order_8	desc 
  ,order_7	desc 
  ,order_6	desc 
  ,order_5	desc 
  ,order_4	desc 
  ,order_3	desc 
  ,order_2	desc 
  ,order_1	desc 
  
